<!DOCTYPE html>
<html>

<head>
    <title>Setup</title>

    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="vendor/web3/web3.min.js"></script>
    <script src="js/env.js"></script>
    <script src="js/web3.min.js"></script>
    <script src="js/walletconnect_v2.js"></script>
    <script src="js/web3-providers-http.min.js"></script>
</head>

<body>
    <section id="divNavPage"></section>
    <section id="setup" class="container mt-5" style="max-width: 540px;">
        <div class="alert d-none" role="alert" id="divStatus">
        </div>
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label for="ddlChain" class="form-label">Chain</label>
                    <select id="ddlChain" class="form-select" aria-label="Default select example">
                        <option selected>Select</option>
                        <option value="Sepolia">Sepolia</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="txtProjectType" class="form-label">Project Name</label>
                    <input class="form-control" id="txtProjectType">
                </div>
                <div class="mb-3">
                    <label for="txtRewardType" class="form-label">Reward Type</label>
                    <input class="form-control" id="txtRewardType">
                </div>
                <div class="mb-3">
                    <label for="txtRules" class="form-label">Scoring Rules</label>
                    <input class="form-control" id="txtRules">
                </div>
                <div id="walletSection">
                    <button id="btnWalletConnect_v2" type="button" onclick="connectWeb3('WalletConnect_v2')"
                        class="btn btn-lg btn-white d-flex justify-content-between align-items-center w-100 p-3 mb-2">
                        <span class="text-dark">WalletConnect</span>
                        <img width="25" src="./images/walletconnect.svg" alt="">
                    </button>
                </div>
                <div id="lblWallet">
                </div>
                <div class="mb-3">
                    <button id="btnSetup" class="btn btn-primary">Setup</button>
                </div>
            </div>
        </div>
    </section>

    <section id="interact" class="container mt-5" style="max-width: 540px;">
        <div class="alert d-none" role="alert" id="divStatus">
        </div>
        <div class="card">
            <div class="card-body">
                <div class="mb-3">
                    <label for="txtContractAddress" class="form-label">Contract Address</label>
                    <input class="form-control" id="txtContractAddress">
                </div>
                <div class="mb-3">
                    <label for="txtBlockData" class="form-label">Data</label>
                    <textarea class="form-control" id="txtBlockData"></textarea>
                </div>
                <div class="mb-3">
                    <button id="btnSubmit" class="btn btn-primary">Send</button>
                </div>
            </div>
        </div>
    </section>
</body>

<script src="js/master.js"></script>
<script>
    var walletObj;
    var walletConnectObj_v2;

    // walletConnect related variable - Create these earlier so we can hook "disconnect" event
    var WalletConnectProvider_v2 = window["@walletconnect/ethereum-provider"].EthereumProvider;

    let web3obj;
    // Web3modal instance
    let web3Modal;
    // Chosen wallet provider given by the dialog window
    let provider;

    async function deployContract(event) {
        event.preventDefault();

        try {
            // Deploy the contract
            const contractABI = [{ "inputs": [{ "internalType": "string", "name": "_projectName", "type": "string" }, { "internalType": "string", "name": "_rewardType", "type": "string" }, { "internalType": "string", "name": "_scoringRules", "type": "string" }], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "writer", "type": "address" }, { "indexed": true, "internalType": "uint256", "name": "blobId", "type": "uint256" }, { "indexed": false, "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }], "name": "BlobWritten", "type": "event" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "blobById", "outputs": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "blobs", "outputs": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getEventPeriod", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getRecurringCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getScoringRules", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "projectName", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "blobId", "type": "uint256" }], "name": "readBlobById", "outputs": [{ "components": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "internalType": "struct BuddyBuddy.BlobData", "name": "", "type": "tuple" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "readLatestBlob", "outputs": [{ "components": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "internalType": "struct BuddyBuddy.BlobData", "name": "", "type": "tuple" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "rewardType", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_eventPeriod", "type": "uint256" }], "name": "setEventPeriod", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_recurringCount", "type": "uint256" }], "name": "setRecurringCount", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "_scoringRules", "type": "string" }], "name": "setScoringRules", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }], "name": "writeBlobData", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];
            const bytecode = '608060405234801562000010575f80fd5b5060405162000b6d38038062000b6d833981016040819052620000339162000129565b5f6200004084826200023e565b5060016200004f83826200023e565b5060026200005e82826200023e565b505050506200030a565b634e487b7160e01b5f52604160045260245ffd5b5f82601f8301126200008c575f80fd5b81516001600160401b0380821115620000a957620000a962000068565b604051601f8301601f19908116603f01168101908282118183101715620000d457620000d462000068565b8160405283815260209250866020858801011115620000f1575f80fd5b5f91505b83821015620001145785820183015181830184015290820190620000f5565b5f602085830101528094505050505092915050565b5f805f606084860312156200013c575f80fd5b83516001600160401b038082111562000153575f80fd5b62000161878388016200007c565b9450602086015191508082111562000177575f80fd5b62000185878388016200007c565b935060408601519150808211156200019b575f80fd5b50620001aa868287016200007c565b9150509250925092565b600181811c90821680620001c957607f821691505b602082108103620001e857634e487b7160e01b5f52602260045260245ffd5b50919050565b601f8211156200023957805f5260205f20601f840160051c81016020851015620002155750805b601f840160051c820191505b8181101562000236575f815560010162000221565b50505b505050565b81516001600160401b038111156200025a576200025a62000068565b62000272816200026b8454620001b4565b84620001ee565b602080601f831160018114620002a8575f8415620002905750858301515b5f19600386901b1c1916600185901b17855562000302565b5f85815260208120601f198616915b82811015620002d857888601518255948401946001909101908401620002b7565b5085821015620002f657878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b61085580620003185f395ff3fe608060405234801561000f575f80fd5b50600436106100cb575f3560e01c80636a39a48f11610088578063c89e2e0e11610063578063c89e2e0e146101a7578063cb1ee57f146101cd578063d38d0a92146101d5578063ddac017d146101dd575f80fd5b80636a39a48f146101775780639a33e3001461017f578063a5d3866014610194575f80fd5b806320c0b630146100cf5780632abc3d4e146100e65780632f4db4c11461010e5780635bfb69f7146101235780636353f8db14610136578063692642e714610164575b5f80fd5b6004545b6040519081526020015b60405180910390f35b6100f96100f4366004610580565b6101e5565b604080519283526020830191909152016100dd565b61012161011c366004610580565b600355565b005b6101216101313660046105ab565b610211565b610149610144366004610580565b610221565b604080518251815260209283015192810192909252016100dd565b610121610172366004610580565b600455565b6101496102ce565b610187610377565b6040516100dd9190610656565b6101216101a2366004610580565b610402565b6100f96101b5366004610580565b60066020525f90815260409020805460019091015482565b6101876104e3565b610187610573565b6003546100d3565b600581815481106101f4575f80fd5b5f9182526020909120600290910201805460019091015490915082565b600261021d8282610726565b5050565b604080518082019091525f8082526020820152600554821061028a5760405162461bcd60e51b815260206004820152601760248201527f426c6f6220494420646f6573206e6f742065786973742e00000000000000000060448201526064015b60405180910390fd5b6005828154811061029d5761029d6107e6565b905f5260205f2090600202016040518060400160405290815f82015481526020016001820154815250509050919050565b604080518082019091525f80825260208201526005546103285760405162461bcd60e51b8152602060048201526015602482015274273790313637b139903bb934ba3a32b7103cb2ba1760591b6044820152606401610281565b60058054610338906001906107fa565b81548110610348576103486107e6565b905f5260205f2090600202016040518060400160405290815f8201548152602001600182015481525050905090565b5f8054610383906106a2565b80601f01602080910402602001604051908101604052809291908181526020018280546103af906106a2565b80156103fa5780601f106103d1576101008083540402835291602001916103fa565b820191905f5260205f20905b8154815290600101906020018083116103dd57829003601f168201915b505050505081565b60408051808201909152818152426020820190815260058054600180820183555f83815285517f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db060029094029384015593517f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db190920191909155905461048891906107fa565b5f8181526006602090815260409182902085518155858201516001909101559051858152919250829133917ff07ddd471575abbdec8064fae85f06ea8cf8716f6d1b281ffb086fa3ce4e77e9910160405180910390a3505050565b6060600280546104f2906106a2565b80601f016020809104026020016040519081016040528092919081815260200182805461051e906106a2565b80156105695780601f1061054057610100808354040283529160200191610569565b820191905f5260205f20905b81548152906001019060200180831161054c57829003601f168201915b5050505050905090565b60018054610383906106a2565b5f60208284031215610590575f80fd5b5035919050565b634e487b7160e01b5f52604160045260245ffd5b5f602082840312156105bb575f80fd5b813567ffffffffffffffff808211156105d2575f80fd5b818401915084601f8301126105e5575f80fd5b8135818111156105f7576105f7610597565b604051601f8201601f19908116603f0116810190838211818310171561061f5761061f610597565b81604052828152876020848701011115610637575f80fd5b826020860160208301375f928101602001929092525095945050505050565b5f602080835283518060208501525f5b8181101561068257858101830151858201604001528201610666565b505f604082860101526040601f19601f8301168501019250505092915050565b600181811c908216806106b657607f821691505b6020821081036106d457634e487b7160e01b5f52602260045260245ffd5b50919050565b601f82111561072157805f5260205f20601f840160051c810160208510156106ff5750805b601f840160051c820191505b8181101561071e575f815560010161070b565b50505b505050565b815167ffffffffffffffff81111561074057610740610597565b6107548161074e84546106a2565b846106da565b602080601f831160018114610787575f84156107705750858301515b5f19600386901b1c1916600185901b1785556107de565b5f85815260208120601f198616915b828110156107b557888601518255948401946001909101908401610796565b50858210156107d257878501515f19600388901b60f8161c191681555b505060018460011b0185555b505050505050565b634e487b7160e01b5f52603260045260245ffd5b8181038181111561081957634e487b7160e01b5f52601160045260245ffd5b9291505056fea2646970667358221220de9f6902edb5a0db9f86c3dd75ed5f12f40c7cb03153288d97c34c1ccbb13cdb64736f6c63430008180033';
            const contract = new web3obj.eth.Contract(contractABI);
            const accounts = await web3obj.eth.getAccounts();

            // Ensure you have the correct values for your contract's constructor parameters
            const projectType = document.getElementById('txtProjectType').value;
            const rewardType = document.getElementById('txtRewardType').value;
            const rules = document.getElementById('txtRules').value;

            const deployedContract = await contract.deploy({
                data: bytecode,
                arguments: [projectType, rewardType, rules] // Pass constructor parameters directly here
            }).send({
                from: accounts[0], // Use the first account to deploy
                gas: 1500000, // Adjust the gas limit as necessary
                // Note: The gas value you provided was quite high; adjust it according to your contract's needs
            });

            // After deployment, the deployed contract instance contains the address
            var divStatus = document.getElementById('divStatus');
            console.log('Contract deployed at address:', deployedContract.options.address);
            divStatus.innerHTML = 'Contract deployed at address:' + deployedContract.options.address;
            divStatus.classList.add('alert-success');

            document.getElementById("txtContractAddress").value = deployedContract.options.address;
            return deployedContract.options.address;
        } catch (error) {
            console.error('Error deploying contract:', error);
            divStatus.innerHTML = 'Error deploying contract:' + error;
            divStatus.classList.add('alert-danger')
        }
        divStatus.classList.remove('d-none')
    }

    document.getElementById("btnSetup").addEventListener("click", deployContract);

    async function exitProvider() {
        if (provider) {
            await provider.close();
            // If the cached provider is not cleared,
            // WalletConnect will default to the existing session
            // and does not allow to re-scan the QR code with a new wallet.
            // Depending on your use case you may want or want not his behavir.
            await web3Modal.clearCachedProvider();
            provider = null;
            window.location.reload(true);
        }
    }

    async function initWalletConnect_v2() {
        walletConnectObj_v2 = await WalletConnectProvider_v2.init({
            projectId: 'ad2cbbc1810a6036a4c3c0c8042073c3', // REQUIRED your projectId
            chains: [11155111],
            showQrModal: true,
            rpcMap:
            {
                '1': 'https://mainnet.infura.io/v3/7809098bc3af4ebdb57464bffac0242c',
                '5': 'https://goerli.infura.io/v3/7809098bc3af4ebdb57464bffac0242c',
                '17000': 'https://ethereum-holesky.publicnode.com',
                '11155111': 'https://1rpc.io/sepolia',
            }
        });
    }

    async function getWeb3Accounts() {
        try {
            const accounts = await web3obj.eth.getAccounts();

            if (accounts.length > 0) {
                const address = accounts[0];
                const isAddress = web3obj.utils.isAddress(address);

                if (isAddress) {
                    // Assuming isAccount is meant to be used elsewhere
                    isAccount = true; // Ensure this variable is declared and managed properly elsewhere
                    return address; // Returns the first account if it's a valid address
                } else {
                    alert('Retrieved address is not valid.');
                    return null; // Handle invalid address case
                }
            } else {
                alert('Please connect to your Web3 provider!');
                return null; // Handle no accounts case
            }
        } catch (err) {
            alert(err + '. Are you sure you are on a secure (SSL / HTTPS) connection?');
            throw err; // Rethrow or handle the error as needed
        }
    }


    async function connectWeb3(type) {
        var cont = false;
        try {

            await initWalletConnect_v2();

            var walletConnectEnableTask = walletConnectObj_v2.connect();
            await walletConnectEnableTask;

            walletConnectObj_v2.on('disconnect', function (error, payload) {
                window.location.reload(true)
            });

            web3obj = new Web3(walletConnectObj_v2);
            nonBrowserWallet = true;
            typeOfLogin = type;

        } catch (err) {
            console.log('Error from Web3Modal: ' + err);
            alert('Failed to establish a connection to ' + type + '.');
            var isInIFrame = (window.location != window.parent.location);
            if (isInIFrame) {
                var element = window.parent.document.getElementById("writecontractiframe");
                element.style.removeProperty("min-height");
            }
            // await resetPage();
            return;
        }

        if (typeof web3obj !== 'undefined') {
            var network = 0;

            getWeb3Accounts().then(accounts => {
                console.log('Retrieved accounts:', accounts);
                // Use the accounts here

                var isAddress = web3obj.utils.isAddress(accounts);

                divWallet = document.getElementById('walletSection');
                divWallet.visible = false;

                lblWallets = document.getElementById('lblWallet');
                lblWallets.innerHTML = '<label for="address" class="form-label">' + accounts + '</label>'

            }).catch(error => {
                console.error('Failed to retrieve accounts:', error);
                // Handle the error here, e.g., user denied account access
            });
            // network = await web3obj.eth.net.getId();
            // netID = network.toString();
            // network = getChainId(netID);

        } else {
            alert('Unable to locate a compatible web3 browser!');
        }
    }

    // Function to send transaction to the contract
    async function sendTransaction(event) {
        event.preventDefault();
        const contractABI2 = [{ "inputs": [{ "internalType": "string", "name": "_projectName", "type": "string" }, { "internalType": "string", "name": "_rewardType", "type": "string" }, { "internalType": "string", "name": "_scoringRules", "type": "string" }], "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "address", "name": "writer", "type": "address" }, { "indexed": true, "internalType": "uint256", "name": "blobId", "type": "uint256" }, { "indexed": false, "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }], "name": "BlobWritten", "type": "event" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "blobById", "outputs": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "name": "blobs", "outputs": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getEventPeriod", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getRecurringCount", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "getScoringRules", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "projectName", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "blobId", "type": "uint256" }], "name": "readBlobById", "outputs": [{ "components": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "internalType": "struct BuddyBuddy.BlobData", "name": "", "type": "tuple" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "readLatestBlob", "outputs": [{ "components": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }, { "internalType": "uint256", "name": "timestamp", "type": "uint256" }], "internalType": "struct BuddyBuddy.BlobData", "name": "", "type": "tuple" }], "stateMutability": "view", "type": "function" }, { "inputs": [], "name": "rewardType", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_eventPeriod", "type": "uint256" }], "name": "setEventPeriod", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "uint256", "name": "_recurringCount", "type": "uint256" }], "name": "setRecurringCount", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "string", "name": "_scoringRules", "type": "string" }], "name": "setScoringRules", "outputs": [], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "bytes32", "name": "blobHash", "type": "bytes32" }], "name": "writeBlobData", "outputs": [], "stateMutability": "nonpayable", "type": "function" }];
        const contractAddress = document.getElementById("txtContractAddress").value; // Update with your contract address
        // Get the contract instance
        const contract = new web3obj.eth.Contract(contractABI2, contractAddress);

        var divStatus = document.getElementById('divStatus')
        try {
            // Get the input value from the form
            const inputValue = document.getElementById("txtBlockData").value;

            // Send transaction to the contract function
            const accounts = await web3obj.eth.getAccounts();
            await contract.methods.writeBlobData(inputValue).send({
                from: accounts[0], // Update with the account you want to send from
                gas: 1500000 // Adjust gas value as needed
            });

            console.log('Transaction sent successfully');
            divStatus.innerHTML = 'Transaction sent successfully'
            divStatus.classList.add('alert-success')
        } catch (error) {
            console.error('Error sending transaction:', error);
            divStatus.innerHTML = 'Error sending transaction:' + error;
            divStatus.classList.add('alert-danger')
        }
        divStatus.classList.remove('d-none')
    }

    // Attach event listener to the form submission
    document.getElementById("btnSubmit").addEventListener("click", sendTransaction);

</script>

</html>